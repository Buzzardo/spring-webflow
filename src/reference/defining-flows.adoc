= Defining Flows
:doctype: book
:sectnums:
:toc: left
:icons: font
:experimental:
:sourcedir: .

[[_defining_flows_introduction]]
== Introduction

This chapter begins the Users Section.
It shows how to implement flows using the flow definition language.
By the end of this chapter you should have a good understanding of language constructs, and be capable of authoring a flow definition. 

[[_flow_overview]]
== What is a flow?

A flow encapsulates a reusable sequence of steps that can execute in different contexts.
Below is a http://www.jjg.net/ia/visvocab/[Garrett Information Architecture] diagram illustrating a reference to a flow that encapsulates the steps of a hotel booking process: 


image::images/hotels-site.png[]


[[_flow_makeup]]
== What is the makeup of a typical flow?

In Spring Web Flow, a flow consists of a series of steps called "states". Entering a state typically results in a view being displayed to the user.
On that view, user events occur that are handled by the state.
These events can trigger transitions to other states which result in view navigations. 

The example below shows the structure of the book hotel flow referenced in the previous diagram: 


image::images/hotels-site-bookhotel-flow.png[]


[[_flow_authoring]]
== How are flows authored?

Flows are authored by web application developers using a simple XML-based flow definition language.
The next steps of this guide will walk you through the elements of this language. 

[[_essential_flow_elements]]
== Essential language elements

[[_flow_element]]
=== flow

Every flow begins with the following root element: 

[source,xml]
----

<?xml version="1.0" encoding="UTF-8"?>
<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
                          https://www.springframework.org/schema/webflow/spring-webflow.xsd">

</flow>
----

All states of the flow are defined within this element.
The first state defined becomes the flow's starting point. 

[[_view_state_element]]
=== view-state

Use the `view-state` element to define a step of the flow that renders a view: 

[source,xml]
----

<view-state id="enterBookingDetails" />
----

By convention, a view-state maps its id to a view template in the directory where the flow is located.
For example, the state above might render [path]_/WEB-INF/hotels/booking/enterBookingDetails.xhtml_				if the flow itself was located in the [path]_/WEB-INF/hotels/booking_ directory. 

[[_transition_element]]
=== transition

Use the `transition` element to handle events that occur within a state: 

[source,xml]
----

<view-state id="enterBookingDetails">
    <transition on="submit" to="reviewBooking" />
</view-state>
----

These transitions drive view navigations. 

[[_end_state_element]]
=== end-state

Use the `end-state` element to define a flow outcome: 

[source,xml]
----

<end-state id="bookingCancelled" />
----

When a flow transitions to a end-state it terminates and the outcome is returned. 

=== Checkpoint: Essential language elements

With the three elements ``view-state``, ``transition``, and ``end-state``, you can quickly express your view navigation logic.
Teams often do this before adding flow behaviors so they can focus on developing the user interface of the application with end users first.
Below is a sample flow that implements its view navigation logic using these elements: 

[source,xml]
----

<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
                          https://www.springframework.org/schema/webflow/spring-webflow.xsd">

    <view-state id="enterBookingDetails">
        <transition on="submit" to="reviewBooking" />
    </view-state>

    <view-state id="reviewBooking">
        <transition on="confirm" to="bookingConfirmed" />
        <transition on="revise" to="enterBookingDetails" />
        <transition on="cancel" to="bookingCancelled" />
    </view-state>

    <end-state id="bookingConfirmed" />

    <end-state id="bookingCancelled" />

</flow>
----

[[_flow_actions]]
== Actions

Most flows need to express more than just view navigation logic.
Typically they also need to invoke business services of the application or other actions. 

Within a flow, there are several points where you can execute actions.
These points are: 

* On flow start
* On state entry
* On view render
* On transition execution
* On state exit
* On flow end

Actions are defined using a concise expression language.
Spring Web Flow uses the Unified EL by default.
The next few sections will cover the essential language elements for defining actions. 

[[_evaluate_element]]
=== evaluate

The action element you will use most often is the `evaluate` element.
Use the `evaluate` element to evaluate an expression at a point within your flow.
With this single tag you can invoke methods on Spring beans or any other flow variable.
For example: 

[source,xml]
----

<evaluate expression="entityManager.persist(booking)" />
----

[[_evaluate_element_result]]
==== Assigning an evaluate result

If the expression returns a value, that value can be saved in the flow's data model called ``flowScope``: 

[source,xml]
----

<evaluate expression="bookingService.findHotels(searchCriteria)" result="flowScope.hotels" />
----

[[_evaluate_element_result_type]]
==== Converting an evaluate result

If the expression returns a value that may need to be converted, specify the desired type using the `result-type` attribute: 

[source,xml]
----

<evaluate expression="bookingService.findHotels(searchCriteria)" result="flowScope.hotels"
          result-type="dataModel"/>
----

[[_checkpoint_actions]]
=== Checkpoint: flow actions

Now review the sample booking flow with actions added: 

[source,xml]
----

<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
                          https://www.springframework.org/schema/webflow/spring-webflow.xsd">

    <input name="hotelId" />

    <on-start>
        <evaluate expression="bookingService.createBooking(hotelId, currentUser.name)"
                  result="flowScope.booking" />
    </on-start>

    <view-state id="enterBookingDetails">
        <transition on="submit" to="reviewBooking" />
    </view-state>

    <view-state id="reviewBooking">
        <transition on="confirm" to="bookingConfirmed" />
        <transition on="revise" to="enterBookingDetails" />
        <transition on="cancel" to="bookingCancelled" />
    </view-state>

    <end-state id="bookingConfirmed" />

    <end-state id="bookingCancelled" />

</flow>
----

This flow now creates a Booking object in flow scope when it starts.
The id of the hotel to book is obtained from a flow input attribute. 

[[_flow_inputoutput]]
== Input/Output Mapping

Each flow has a well-defined input/output contract.
Flows can be passed input attributes when they start, and can return output attributes when they end.
In this respect, calling a flow is conceptually similar to calling a method with the following signature: 

[source,java]
----

FlowOutcome flowId(Map<String, Object> inputAttributes);
----

$$...$$ where a `FlowOutcome` has the following signature: 

[source,java]
----

public interface FlowOutcome {
   public String getName();
   public Map<String, Object> getOutputAttributes();
}
----

[[_input_element]]
=== input

Use the `input` element to declare a flow input attribute: 

[source,xml]
----

<input name="hotelId" />
----

Input values are saved in flow scope under the name of the attribute.
For example, the input above would be saved under the name ``hotelId``. 

[[_input_element_type]]
==== Declaring an input type

Use the `type` attribute to declare the input attribute's type: 

[source,xml]
----

<input name="hotelId" type="long" />
----

If an input value does not match the declared type, a type conversion will be attempted. 

[[_input_element_value]]
==== Assigning an input value

Use the `value` attribute to specify an expression to assign the input value to: 

[source,xml]
----

<input name="hotelId" value="flowScope.myParameterObject.hotelId" />
----

If the expression's value type can be determined, that metadata will be used for type coersion if no `type` attribute is specified. 

[[_input_element_required]]
==== Marking an input as required

Use the `required` attribute to enforce the input is not null or empty: 

[source,xml]
----

<input name="hotelId" type="long" value="flowScope.hotelId" required="true" />
----

[[_output_element]]
=== output

Use the `output` element to declare a flow output attribute.
Output attributes are declared within end-states that represent specific flow outcomes. 

[source,xml]
----

<end-state id="bookingConfirmed">
    <output name="bookingId" />
</end-state>
----

Output values are obtained from flow scope under the name of the attribute.
For example, the output above would be assigned the value of the `bookingId` variable. 

[[_output_element_value]]
==== Specifying the source of an output value

Use the `value` attribute to denote a specific output value expression: 

[source,xml]
----

<output name="confirmationNumber" value="booking.confirmationNumber" />
----

[[_checkpoint_input_output]]
=== Checkpoint: input/output mapping

Now review the sample booking flow with input/output mapping: 

[source,xml]
----

<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
                          https://www.springframework.org/schema/webflow/spring-webflow.xsd">

    <input name="hotelId" />

    <on-start>
        <evaluate expression="bookingService.createBooking(hotelId, currentUser.name)"
                  result="flowScope.booking" />
    </on-start>

    <view-state id="enterBookingDetails">
        <transition on="submit" to="reviewBooking" />
    </view-state>

    <view-state id="reviewBooking">
        <transition on="confirm" to="bookingConfirmed" />
        <transition on="revise" to="enterBookingDetails" />
        <transition on="cancel" to="bookingCancelled" />
    </view-state>

    <end-state id="bookingConfirmed" >
        <output name="bookingId" value="booking.id"/>
    </end-state>

    <end-state id="bookingCancelled" />

</flow>
----

The flow now accepts a `hotelId` input attribute and returns a `bookingId` output attribute when a new booking is confirmed. 

[[_flow_variables]]
== Variables

A flow may declare one or more instance variables.
These variables are allocated when the flow starts.
Any `@Autowired` transient references the variable holds are also rewired when the flow resumes. 

[[_var_element]]
=== var

Use the `var` element to declare a flow variable: 

[source,xml]
----

<var name="searchCriteria" class="com.mycompany.myapp.hotels.search.SearchCriteria"/>
----

Make sure your variable's class implements ``java.io.Serializable``, as the instance state is saved between flow requests. 

[[_scopes]]
== Variable Scopes

Web Flow can store variables in one of several scopes: 

=== Flow Scope

Flow scope gets allocated when a flow starts and destroyed when the flow ends.
With the default implementation, any objects stored in flow scope need to be Serializable. 

=== View Scope

View scope gets allocated when a `view-state` enters and destroyed when the state exits.
View scope is _only_ referenceable from within a ``view-state``.
With the default implementation, any objects stored in view scope need to be Serializable. 

=== Request Scope

Request scope gets allocated when a flow is called and destroyed when the flow returns. 

=== Flash Scope

Flash scope gets allocated when a flow starts, cleared after every view render, and destroyed when the flow ends.
With the default implementation, any objects stored in flash scope need to be Serializable. 

=== Conversation Scope

Conversation scope gets allocated when a top-level flow starts and destroyed when the top-level flow ends.
Conversation scope is shared by a top-level flow and all of its subflows.
With the default implementation, conversation scoped objects are stored in the HTTP session and should generally be Serializable to account for typical session replication. 

The scope to use is often determined contextually, for example depending on where a variable is defined -- at the start of the flow definition (flow scope), inside a a view state (view scope), etc.
In other cases, for example in EL expressions and Java code, it needs to be specified explicitly.
Subsequent sections explain how this is done. 

== Calling subflows

A flow may call another flow as a subflow.
The flow will wait until the subflow returns, then respond to the subflow outcome. 

[[_subflow_state_element]]
=== subflow-state

Use the `subflow-state` element to call another flow as a subflow: 

[source,xml]
----

<subflow-state id="addGuest" subflow="createGuest">
    <transition on="guestCreated" to="reviewBooking">
        <evaluate expression="booking.guests.add(currentEvent.attributes.guest)" />
    </transition>
    <transition on="creationCancelled" to="reviewBooking" />
</subflow-state>
----

The above example calls the `createGuest` flow, then waits for it to return.
When the flow returns with a `guestCreated` outcome, the new guest is added to the booking's guest list. 

[[_subflow_state_element_input]]
==== Passing a subflow input

Use the `input` element to pass input to the subflow: 

[source,xml]
----

<subflow-state id="addGuest" subflow="createGuest">
    <input name="booking" />
    <transition to="reviewBooking" />
</subflow-state>
----

[[_subflow_state_element_output]]
==== Mapping subflow output

When a subflow completes, its end-state id is returned to the calling flow as the event to use to continue navigation. 

The subflow can also create output attributes to which the calling flow can refer within an outcome transition as follows: 

[source,xml]
----

<transition on="guestCreated" to="reviewBooking">
    <evaluate expression="booking.guests.add(currentEvent.attributes.guest)" />
</transition>
----

In the above example, `guest` is the name of an output attribute returned by the `guestCreated` outcome. 

[[_checkpoint_subflow]]
=== Checkpoint: calling subflows

Now review the sample booking flow calling a subflow: 

[source,xml]
----

<flow xmlns="http://www.springframework.org/schema/webflow"
      xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
      xsi:schemaLocation="http://www.springframework.org/schema/webflow
                          https://www.springframework.org/schema/webflow/spring-webflow.xsd">

    <input name="hotelId" />

    <on-start>
        <evaluate expression="bookingService.createBooking(hotelId, currentUser.name)"
                  result="flowScope.booking" />
    </on-start>

    <view-state id="enterBookingDetails">
        <transition on="submit" to="reviewBooking" />
    </view-state>

    <view-state id="reviewBooking">
        <transition on="addGuest" to="addGuest" />
        <transition on="confirm" to="bookingConfirmed" />
        <transition on="revise" to="enterBookingDetails" />
        <transition on="cancel" to="bookingCancelled" />
    </view-state>

    <subflow-state id="addGuest" subflow="createGuest">
        <transition on="guestCreated" to="reviewBooking">
            <evaluate expression="booking.guests.add(currentEvent.attributes.guest)" />
        </transition>
        <transition on="creationCancelled" to="reviewBooking" />
    </subflow-state>

    <end-state id="bookingConfirmed" >
        <output name="bookingId" value="booking.id" />
    </end-state>

    <end-state id="bookingCancelled" />

</flow>
----

The flow now calls a `createGuest` subflow to add a new guest to the guest list. 